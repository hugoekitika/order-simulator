<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Simulator - Program</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Tabella Generata</h1>

    <div class="main-content">
      <!-- Blocco note (sidebar sinistra) -->
      <div id="notepad">
        <h2>Blocco Note</h2>
        <p class="notepad-subtitle">dai liberamente un nome ad ogni valore</p>
        <div id="note-entries" aria-live="polite"></div>
        <p class="notepad-hint">
          Usa gli input per assegnare etichette testuali ai numeri mostrati nelle caselle. Le etichette restano solo qui e non modificano i numeri nelle caselle.
        </p>
      </div>

      <!-- Tabella (centro) -->
      <div id="table-container"></div>

      <!-- Istruzioni (destra) -->
      <div id="instructions">
        <h3>Istruzioni</h3>
        <ul>
          <li>Clicca una volta per bloccare la casella.</li>
          <li>Clicca due volte per modificare manualmente il numero nella casella.</li>
          <li>Al terzo click la casella si sblocca.</li>
          <li>Premi "Genera di nuovo" per riassegnare i numeri alle caselle non bloccate.</li>
        </ul>
      </div>
    </div>

    <div class="buttons">
      <button id="reload">Genera di nuovo </button>
      <button onclick="window.location.href='index.html'">Torna alla Home</button>
    </div>
  </div>

  <script src="script.js"></script>

  <!-- Script che gestisce il Blocco Note come area di etichette (non modifica le caselle) -->
  <script>
    (function () {
      const entriesContainer = document.getElementById('note-entries');
      const tableContainer = document.getElementById('table-container');
      const STORAGE_KEY = 'noteLabels_v1';

      if (!entriesContainer || !tableContainer) return;

      // carica etichette da localStorage (oggetto: { "1": "Etichetta 1", "2":"..." })
      function loadLabels() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (e) {
          return {};
        }
      }

      function saveLabels(labels) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(labels));
        } catch (e) {
          // ignore
        }
      }

      let noteLabels = loadLabels();

      // Ricostruisce il blocco note: elenca tutti i numeri presenti nelle td (ord. asc.)
      function rebuildNotepad() {
        const tdList = Array.from(tableContainer.querySelectorAll('td'));
        // prendi solo valori numerici dalle celle
        const nums = tdList
          .map(td => td.textContent.trim())
          .filter(text => /^\d+$/.test(text))
          .map(Number);

        const uniqueNums = Array.from(new Set(nums)).sort((a, b) => a - b);

        entriesContainer.innerHTML = '';

        if (uniqueNums.length === 0) {
          const hint = document.createElement('div');
          hint.className = 'notepad-empty';
          hint.textContent = 'La tabella non Ã¨ ancora generata.';
          entriesContainer.appendChild(hint);
          return;
        }

        uniqueNums.forEach((num) => {
          const entry = document.createElement('div');
          entry.className = 'note-entry';

          const idxSpan = document.createElement('span');
          idxSpan.className = 'idx';
          idxSpan.textContent = num + '=';

          const input = document.createElement('input');
          input.value = noteLabels[String(num)] || '';
          input.setAttribute('aria-label', `Etichetta per ${num}`);

          // Quando si modifica l'input nel blocco note, salviamo solo l'etichetta in localStorage.
          input.addEventListener('input', () => {
            noteLabels[String(num)] = input.value;
            saveLabels(noteLabels);
          });

          entry.appendChild(idxSpan);
          entry.appendChild(input);
          entriesContainer.appendChild(entry);
        });
      }

      // Osserviamo table-container per cambiamenti (rigenerazione tabella, testo celle, classi)
      const observer = new MutationObserver(() => {
        if (observer._timer) clearTimeout(observer._timer);
        observer._timer = setTimeout(() => {
          rebuildNotepad();
        }, 25);
      });

      observer.observe(tableContainer, { childList: true, subtree: true, characterData: true, attributes: true });

      // Build iniziale: aspettiamo un tick per permettere a script.js di generare la tabella
      setTimeout(rebuildNotepad, 50);

      // Esponiamo una funzione per debug/uso manuale
      window._rebuildNotepad = rebuildNotepad;
      window._noteLabels = noteLabels;
    })();
  </script>
</body>
</html>
